<!DOCTYPE html>
<html>
<head>
    <title>Pro Engine Performance Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-box { border: 1px solid #ddd; padding: 20px; margin: 20px 0; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
        #logs { background: #f5f5f5; padding: 15px; height: 400px; overflow-y: scroll; font-family: monospace; }
        .success { color: green; }
        .error { color: red; }
        input[type="file"] { margin: 10px 0; }
        input[type="number"] { width: 100px; margin: 0 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Pro Engine Multi-Threading Performance Test</h1>
        
        <div class="test-box">
            <h3>Upload and Process Image</h3>
            <input type="file" id="imageInput" accept="image/*">
            <br>
            Scale Factor: <input type="number" id="scaleFactor" value="2" min="1" max="15" step="0.1">
            <br>
            <button onclick="processImage()">Start Processing</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
        
        <div class="test-box">
            <h3>Performance Logs</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logs.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function processImage() {
            const fileInput = document.getElementById('imageInput');
            const scaleFactorInput = document.getElementById('scaleFactor');
            
            if (!fileInput.files[0]) {
                log('Please select an image file first', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const scaleFactor = parseFloat(scaleFactorInput.value);
            
            log(`üöÄ Starting processing: ${file.name} (${(file.size/1024).toFixed(1)}KB) with scale factor ${scaleFactor}`);
            
            // Convert file to base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageData = e.target.result;
                const sessionId = `test-${Date.now()}`;
                
                try {
                    log('üì§ Sending processing request...');
                    
                    const response = await fetch('/api/process-large', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            imageData: imageData,
                            scaleFactor: scaleFactor,
                            format: 'png',
                            quality: 95
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    log(`‚úÖ Processing started: ${result.message}`, 'success');
                    
                    // Monitor progress
                    const eventSource = new EventSource(`/api/progress/${sessionId}`);
                    
                    eventSource.onmessage = (event) => {
                        try {
                            const progress = JSON.parse(event.data);
                            
                            if (progress.status === 'complete') {
                                eventSource.close();
                                log(`üéâ Processing completed! Check Downloads/ProUpscaler folder`, 'success');
                                if (progress.processingTime) {
                                    log(`‚ö° Processing time: ${progress.processingTime}ms`, 'success');
                                }
                                if (progress.throughput) {
                                    log(`‚ö° Throughput: ${progress.throughput} pixels/second`, 'success');
                                }
                            } else if (progress.status === 'error') {
                                eventSource.close();
                                log(`‚ùå Processing failed: ${progress.message}`, 'error');
                            } else {
                                log(`üìà Progress: ${progress.progress}% - ${progress.message}`);
                            }
                        } catch (error) {
                            log(`‚ùå Progress parsing error: ${error.message}`, 'error');
                        }
                    };
                    
                    eventSource.onerror = (error) => {
                        eventSource.close();
                        log('‚ùå Connection to progress stream lost', 'error');
                    };
                    
                } catch (error) {
                    log(`‚ùå Processing failed: ${error.message}`, 'error');
                }
            };
            
            reader.readAsDataURL(file);
        }
        
        // Log startup info
        log('üß™ Pro Engine Performance Test Ready');
        log('Upload an image and set scale factor to test multi-threading optimizations');
    </script>
</body>
</html> 